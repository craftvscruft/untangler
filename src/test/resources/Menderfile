FROM 43a3a253

ENV DEFAULT_FILE=main.c
ENV UNTANGLER_DEFAULT_FILE=main.c
ENV JAVA_HOME=/Library/Java/JavaVirtualMachines/graalvm-jdk-20.0.2+9.1/Contents/Home/
ENV PATH="$PATH:/Users/rmyers/dev/untangler/build/install/untangler/bin"

## Aliases
RECIPE move_includes_to_top --msg "Move includes to top" \
  grep "^#include" $UNTANGLER_DEFAULT_FILE > a.tmp && \
  grep -v "^#include" $UNTANGLER_DEFAULT_FILE >> a.tmp && \
  mv a.tmp $UNTANGLER_DEFAULT_FILE
RECIPE format --msg="d - Formatting" clang-format -i $UNTANGLER_DEFAULT_FILE
RECIPE rename --msg="R - Rename $1 to $2" untangler rename $arg1 $arg2 -w

RECIPE remove_comments_in_includes --msg="d - Remove comments in includes" \
  perl -pi -e 's{^#include */\*((?!\*/).)*\*/}{#include}gs' $UNTANGLER_DEFAULT_FILE

RECIPE remove_comments --msg="d - Remove comments" \
  untangler remove comment "*" --sub=" " -w

RECIPE split_declarations --msg="r - Split declarations" \
  untangler misc split-declaration "*" -w


BEFORE_ALL make clean && make test

# Phase 1
# BICR: Binary Identical && Commit || Revert
BEFORE_EACH make && cp a.out a.bak
AFTER_EACH diff a.out a.out.bak

RUN remove_comments_in_includes
RUN remove_comments
RUN format
RUN move_includes_to_top
RUN split_declarations

# Phase 2
# TCR: Test && Commit || Revert
BEFORE_EACH make && cp a.out a.bak
AFTER_EACH make test

RUN rename B calculate_value
RUN rename b evaluate_and_draw_interval
# - rename t start_t
# - rename u end_t
# - rename s difference
RUN rename X control_points
RUN rename P point_value
RUN rename O offset
RUN rename m pixel_index
RUN rename k color_value
RUN rename S screen_buffer
